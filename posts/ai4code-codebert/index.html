<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="codebert(base) - [1md+20code]’s CLS ranking 0.8412" /><meta name="author" content="mng" /><meta property="og:locale" content="en" /><meta name="description" content="Preprocess" /><meta property="og:description" content="Preprocess" /><link rel="canonical" href="https://moongthy.github.io/posts/ai4code-codebert/" /><meta property="og:url" content="https://moongthy.github.io/posts/ai4code-codebert/" /><meta property="og:site_name" content="MNG" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-10T11:15:03+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="codebert(base) - [1md+20code]’s CLS ranking 0.8412" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@mng" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"mng"},"dateModified":"2022-09-10T11:15:03+09:00","datePublished":"2022-09-10T11:15:03+09:00","description":"Preprocess","headline":"codebert(base) - [1md+20code]’s CLS ranking 0.8412","mainEntityOfPage":{"@type":"WebPage","@id":"https://moongthy.github.io/posts/ai4code-codebert/"},"url":"https://moongthy.github.io/posts/ai4code-codebert/"}</script><title>codebert(base) - [1md+20code]’s CLS ranking 0.8412 | MNG</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="MNG"><meta name="application-name" content="MNG"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/archan.gif" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">MNG</a></div><div class="site-subtitle font-italic">Student, 26</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Moongthy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['mungeunj','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>codebert(base) - [1md+20code]’s CLS ranking 0.8412</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>codebert(base) - [1md+20code]’s CLS ranking 0.8412</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1662776103" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 10, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> mng </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1440 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><h1 id="preprocess">Preprocess</h1><p>기본적인 데이터 추출은 baseline의 그것과 같다</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Preprocessor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__dict__</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">input_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_notebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pd</span><span class="p">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s">'cell_type'</span><span class="p">:</span> <span class="s">'category'</span><span class="p">,</span> <span class="s">'source'</span><span class="p">:</span> <span class="s">'str'</span><span class="p">})</span>
            <span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">path</span><span class="p">.</span><span class="n">stem</span><span class="p">)</span>
            <span class="p">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s">'cell_id'</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ranks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">derived</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">base</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">derived</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'train'</span><span class="p">,</span> <span class="n">nvalid</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">train_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">val_path</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'train_df, val_df are already exits'</span><span class="p">)</span>
            <span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">train_path</span><span class="p">)</span>
            <span class="n">val_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">val_path</span><span class="p">)</span> 
            <span class="n">train_df_mark</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">train_mark_path</span><span class="p">)</span>
            <span class="n">val_df_mark</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">val_mark_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">train_df_mark</span><span class="p">,</span> <span class="n">val_df_mark</span>

        <span class="n">paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">data_dir</span> <span class="o">/</span> <span class="n">mode</span><span class="p">).</span><span class="n">glob</span><span class="p">(</span><span class="s">'*.json'</span><span class="p">))</span>
        <span class="n">notebooks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">read_notebook</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s"> NBs'</span><span class="p">)]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="n">notebooks</span><span class="p">)</span>
              <span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
              <span class="p">.</span><span class="n">swaplevel</span><span class="p">()</span>
              <span class="p">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s">'id'</span><span class="p">,</span> <span class="n">sort_remaining</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

        <span class="n">df_orders</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s">'train_orders.csv'</span><span class="p">,</span>
            <span class="n">index_col</span><span class="o">=</span><span class="s">'id'</span><span class="p">,</span>
            <span class="n">squeeze</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="n">split</span><span class="p">()</span>

        <span class="n">df_orders_</span> <span class="o">=</span> <span class="n">df_orders</span><span class="p">.</span><span class="n">to_frame</span><span class="p">().</span><span class="n">join</span><span class="p">(</span>
            <span class="n">df</span><span class="p">.</span><span class="n">reset_index</span><span class="p">(</span><span class="s">'cell_id'</span><span class="p">).</span><span class="n">groupby</span><span class="p">(</span><span class="s">'id'</span><span class="p">)[</span><span class="s">'cell_id'</span><span class="p">].</span><span class="nb">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span>
            <span class="n">how</span><span class="o">=</span><span class="s">'right'</span>
        <span class="p">)</span>

        <span class="n">ranks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">cell_order</span><span class="p">,</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">df_orders_</span><span class="p">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">ranks</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">'cell_id'</span><span class="p">:</span> <span class="n">cell_id</span><span class="p">,</span>
                          <span class="s">'rank'</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_ranks</span><span class="p">(</span><span class="n">cell_order</span><span class="p">,</span> <span class="n">cell_id</span><span class="p">)}</span>

        <span class="n">df_ranks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span>
            <span class="p">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s">'index'</span><span class="p">)</span>
            <span class="p">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s">'id'</span><span class="p">)</span>
            <span class="p">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">.</span><span class="n">explode</span><span class="p">)</span>
            <span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'cell_id'</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">df_ancestors</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">data_dir</span> <span class="o">/</span> <span class="s">'train_ancestors.csv'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s">'id'</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">reset_index</span><span class="p">().</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df_ranks</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'cell_id'</span><span class="p">]).</span><span class="n">merge</span><span class="p">(</span><span class="n">df_ancestors</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s">'id'</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s">'pct_rank'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'rank'</span><span class="p">]</span> <span class="o">/</span> \
            <span class="n">df</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'id'</span><span class="p">)[</span><span class="s">'cell_id'</span><span class="p">].</span><span class="n">transform</span><span class="p">(</span><span class="s">'count'</span><span class="p">)</span>

        <span class="n">splitter</span> <span class="o">=</span> <span class="n">GroupShuffleSplit</span><span class="p">(</span>
            <span class="n">n_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">nvalid</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">train_ind</span><span class="p">,</span> <span class="n">val_ind</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">splitter</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'ancestor_id'</span><span class="p">]))</span>
            
        <span class="n">train_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_ind</span><span class="p">].</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">val_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">val_ind</span><span class="p">].</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">train_df_mark</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">train_df</span><span class="p">[</span><span class="s">'cell_type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'markdown'</span><span class="p">].</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">val_df_mark</span> <span class="o">=</span> <span class="n">val_df</span><span class="p">[</span><span class="n">val_df</span><span class="p">[</span><span class="s">'cell_type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'markdown'</span><span class="p">].</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">train_df_mark</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">train_mark_path</span> <span class="o">+</span> <span class="sa">f</span><span class="s">'_fold</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
        <span class="n">val_df_mark</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">val_mark_path</span> <span class="o">+</span> <span class="sa">f</span><span class="s">'_fold</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

        <span class="n">train_df</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">train_path</span> <span class="o">+</span> <span class="sa">f</span><span class="s">'_fold</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
        <span class="n">val_df</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">val_path</span> <span class="o">+</span> <span class="sa">f</span><span class="s">'_fold</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">train_df_mark</span><span class="p">,</span> <span class="n">val_df_mark</span>
</pre></table></code></div></div><p>여기에 추가적으로 노트북 당 최대 20개의 코드셀과 코드 셀 개수, 마크 다운 셀의 개수를 추출</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">_20CodeCellPreprocessor</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">__dict__</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_20CodeCellPreprocessor</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">clean_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s">'</span><span class="se">\\</span><span class="s">n'</span><span class="p">,</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sample_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">clean_code</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">):</span> <span class="c1"># 코드 셀이 20개 이하라면 그냥 반환
</span>            <span class="k">return</span> <span class="p">[</span><span class="n">cell</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span> <span class="c1"># 총 20개의 코드셀이 샘플링 되도록 스텝을 조절
</span>            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">round</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)):</span>
                <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nb">round</span><span class="p">(</span><span class="n">idx</span><span class="p">))])</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="n">step</span>
            <span class="k">assert</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">results</span> <span class="c1"># 첫번쨰 코드셀은 반드시 들어가야 한다?
</span>            <span class="k">if</span> <span class="n">cells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span> <span class="c1"># 말전 코드셀은 반드시 들어가야 한다?
</span>                <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">get_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s">'rank'</span><span class="p">).</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sub_df</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'id'</span><span class="p">)):</span>
            <span class="n">features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">total_md</span> <span class="o">=</span> <span class="n">sub_df</span><span class="p">[</span><span class="n">sub_df</span><span class="p">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s">'markdown'</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">code_sub_df</span> <span class="o">=</span> <span class="n">sub_df</span><span class="p">[</span><span class="n">sub_df</span><span class="p">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="s">'code'</span><span class="p">]</span>
            <span class="n">total_code</span> <span class="o">=</span> <span class="n">code_sub_df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">codes</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">sample_cells</span><span class="p">(</span><span class="n">code_sub_df</span><span class="p">.</span><span class="n">source</span><span class="p">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">features</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s">'total_code'</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_code</span>
            <span class="n">features</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s">'total_md'</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_md</span>
            <span class="n">features</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s">'codes'</span><span class="p">]</span> <span class="o">=</span> <span class="n">codes</span>

        <span class="c1"># features = {
</span>        <span class="c1">#     노트북id: {
</span>        <span class="c1">#         'total_code': 코드 셀의 개수,
</span>        <span class="c1">#         'total_md': 마크다운 샐의 개수,
</span>        <span class="c1">#         'codes': [코드셀0, 코드셀1, ... , 코드셀 19]
</span>        <span class="c1">#     },
</span>        <span class="c1">#     ...
</span>        <span class="c1"># }
</span>        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">train_df_mark</span><span class="p">,</span> <span class="n">val_df_mark</span> <span class="o">=</span> <span class="nb">super</span><span class="p">().</span><span class="n">run</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">train_features_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">val_features_path</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'train_fts, val_fts are already exists'</span><span class="p">)</span>
            <span class="n">train_fts</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">train_features_path</span><span class="p">))</span>
            <span class="n">val_fts</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">val_features_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">train_fts</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_features</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
            <span class="n">val_fts</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">get_features</span><span class="p">(</span><span class="n">val_df</span><span class="p">)</span>          
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">train_fts</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">train_features_path</span><span class="p">,</span><span class="s">"wt"</span><span class="p">))</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">val_fts</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">val_features_path</span><span class="p">,</span><span class="s">"wt"</span><span class="p">))</span>    

        <span class="k">return</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">train_df_mark</span><span class="p">,</span> <span class="n">val_df_mark</span><span class="p">,</span> <span class="n">train_fts</span><span class="p">,</span> <span class="n">val_fts</span>
</pre></table></code></div></div><h1 id="dataset">Dataset</h1><p>BERT에 입력할 커스텀 데이터셋을 만들어줘야 한다</p><p>하나의 입력 시퀀스 : [마크다운셀 1개, 코드셀 0, 코드셀 1, … , 코드셀 19]</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">_20SampleDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">total_max_len</span><span class="p">,</span> <span class="n">md_max_len</span><span class="p">,</span> <span class="n">fts</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">md_max_len</span> <span class="o">=</span> <span class="n">md_max_len</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">total_max_len</span> <span class="o">=</span> <span class="n">total_max_len</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fts</span> <span class="o">=</span> <span class="n">fts</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="p">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">tokenizer</span><span class="p">.</span><span class="n">encode_plus</span><span class="p">(</span>
            <span class="n">row</span><span class="p">.</span><span class="n">source</span><span class="p">,</span>
            <span class="bp">None</span><span class="p">,</span>
            <span class="n">add_special_tokens</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">md_max_len</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="s">'max_length'</span><span class="p">,</span>
            <span class="n">return_token_type_ids</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">truncation</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">)</span>

        <span class="n">code_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">tokenizer</span><span class="p">.</span><span class="n">batch_encode_plus</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">fts</span><span class="p">[</span><span class="n">row</span><span class="p">.</span><span class="nb">id</span><span class="p">][</span><span class="s">'codes'</span><span class="p">]],</span>
            <span class="n">add_special_tokens</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="s">'max_length'</span><span class="p">,</span>
            <span class="n">truncation</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">)</span>

        <span class="n">n_md</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fts</span><span class="p">[</span><span class="n">row</span><span class="p">.</span><span class="nb">id</span><span class="p">][</span><span class="s">'total_md'</span><span class="p">]</span>
        <span class="n">n_code</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fts</span><span class="p">[</span><span class="n">row</span><span class="p">.</span><span class="nb">id</span><span class="p">][</span><span class="s">'total_code'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_md</span> <span class="o">+</span> <span class="n">n_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fts</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">FloatTensor</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fts</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">FloatTensor</span><span class="p">([</span><span class="n">n_md</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_md</span> <span class="o">+</span> <span class="n">n_code</span><span class="p">)])</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s">'input_ids'</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">code_inputs</span><span class="p">[</span><span class="s">'input_ids'</span><span class="p">]:</span>
            <span class="n">ids</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[:</span><span class="bp">self</span><span class="p">.</span><span class="n">total_max_len</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">.</span><span class="n">total_max_len</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">tokenizer</span><span class="p">.</span><span class="n">pad_token_id</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">total_max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s">'attention_mask'</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">code_inputs</span><span class="p">[</span><span class="s">'attention_mask'</span><span class="p">]:</span>
            <span class="n">mask</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:</span><span class="bp">self</span><span class="p">.</span><span class="n">total_max_len</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">.</span><span class="n">total_max_len</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">tokenizer</span><span class="p">.</span><span class="n">pad_token_id</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">total_max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ids</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">fts</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="n">FloatTensor</span><span class="p">([</span><span class="n">row</span><span class="p">.</span><span class="n">pct_rank</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></table></code></div></div><h1 id="model">Model</h1><p>위 입력 시퀀스의 [cls]의 표현 벡터를 추출</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">_20SampleModel</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_20SampleModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        
        <span class="n">config</span> <span class="o">=</span> <span class="n">AutoConfig</span><span class="p">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModel</span><span class="p">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dropout1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dropout2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dropout3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dropout4</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dropout5</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">hidden_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># for train_fts
</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">fts</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">fts</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># [CLS]만 쓸거임.
</span>        
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">top</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">dropout1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">top</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">dropout2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">top</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">dropout3</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">top</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">dropout4</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x5</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">top</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">dropout5</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">x3</span> <span class="o">+</span> <span class="n">x4</span> <span class="o">+</span> <span class="n">x5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></table></code></div></div><h1 id="train">Train</h1><p>훈련 시 필요한 것들 세팅</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">train_setup</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">_20SampleModel</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">model_name_or_path</span><span class="p">)</span>
    <span class="n">param_optimizer</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">named_parameters</span><span class="p">())</span>
    <span class="n">no_decay</span> <span class="o">=</span> <span class="p">[</span><span class="s">'bias'</span><span class="p">,</span> <span class="s">'LayerNorm.bias'</span><span class="p">,</span> <span class="s">'LayerNorm.weight'</span><span class="p">]</span>
    <span class="n">optimizer_grouped_parameters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s">'params'</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_optimizer</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">nd</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">no_decay</span><span class="p">)],</span> <span class="s">'weight_decay'</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
        <span class="p">{</span><span class="s">'params'</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_optimizer</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">nd</span> <span class="ow">in</span> <span class="n">n</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">no_decay</span><span class="p">)],</span> <span class="s">'weight_decay'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
    <span class="p">]</span>
    <span class="n">num_train_optimization_steps</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">num_train_steps</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">AdamW</span><span class="p">(</span><span class="n">optimizer_grouped_parameters</span><span class="p">,</span>
                      <span class="n">lr</span><span class="o">=</span><span class="mf">3e-5</span><span class="p">,</span> <span class="n">correct_bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">CosineAnnealingWarmupRestarts</span><span class="p">(</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
            <span class="n">first_cycle_steps</span><span class="o">=</span><span class="n">num_train_optimization_steps</span><span class="p">,</span>
            <span class="n">cycle_mult</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">max_lr</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">max_lr</span><span class="p">,</span>
            <span class="n">min_lr</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">min_lr</span><span class="p">,</span>
            <span class="n">warmup_steps</span><span class="o">=</span><span class="n">num_train_optimization_steps</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="n">gamma</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
            <span class="n">last_epoch</span><span class="o">=-</span><span class="mi">1</span>
        <span class="p">))</span>  <span class="c1"># Pytorch scheduler
</span>
    <span class="c1"># scheduler = get_linear_schedule_with_warmup(
</span>    <span class="c1">#     optimizer=optimizer,
</span>    <span class="c1">#     num_warmup_steps=0.05*num_train_optimization_steps,
</span>    <span class="c1">#     num_training_steps=num_train_optimization_steps,
</span>    <span class="c1"># )
</span>    <span class="n">scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">amp</span><span class="p">.</span><span class="n">GradScaler</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">scaler</span>

<span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">cuda</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">):</span>
    <span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>

    <span class="n">tbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">val_loader</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbar</span><span class="p">):</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">amp</span><span class="p">.</span><span class="n">autocast</span><span class="p">():</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span>

            <span class="n">preds</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">.</span><span class="n">detach</span><span class="p">().</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">().</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">labels</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">detach</span><span class="p">().</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">().</span><span class="n">ravel</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">scaler</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">df_orders</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">criterion</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">L1Loss</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">epoch</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
        <span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>

        <span class="n">tbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tbar</span><span class="p">):</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">amp</span><span class="p">.</span><span class="n">autocast</span><span class="p">():</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">*</span><span class="n">inputs</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">scaler</span><span class="p">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">).</span><span class="n">backward</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="n">args</span><span class="p">.</span><span class="n">accumulation_steps</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbar</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">scaler</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
                <span class="n">scaler</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">scheduler</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

            <span class="n">loss_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="n">detach</span><span class="p">().</span><span class="n">cpu</span><span class="p">().</span><span class="n">item</span><span class="p">())</span>
            <span class="n">preds</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">.</span><span class="n">detach</span><span class="p">().</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">().</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">labels</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">detach</span><span class="p">().</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">().</span><span class="n">ravel</span><span class="p">())</span>

            <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_list</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>

            <span class="n">tbar</span><span class="p">.</span><span class="n">set_description</span><span class="p">(</span>
                <span class="sa">f</span><span class="s">'Epoch </span><span class="si">{</span><span class="n">e</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s"> Loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">}</span><span class="s"> lr: </span><span class="si">{</span><span class="n">scheduler</span><span class="p">.</span><span class="n">get_lr</span><span class="p">()</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

        <span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span> <span class="o">=</span> <span class="n">validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">)</span>
        <span class="n">val_df</span><span class="p">[</span><span class="s">'pred'</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_df</span><span class="p">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'id'</span><span class="p">,</span> <span class="s">'cell_type'</span><span class="p">])[</span><span class="s">'rank'</span><span class="p">].</span><span class="n">rank</span><span class="p">(</span><span class="n">pct</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">val_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">val_df</span><span class="p">[</span><span class="s">'cell_type'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'markdown'</span><span class="p">,</span> <span class="s">'pred'</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>
        <span class="n">y_dummy</span> <span class="o">=</span> <span class="n">val_df</span><span class="p">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s">'pred'</span><span class="p">).</span><span class="n">groupby</span><span class="p">(</span><span class="s">'id'</span><span class="p">)[</span><span class="s">'cell_id'</span><span class="p">].</span><span class="nb">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">preds_score</span> <span class="o">=</span> <span class="n">kendall_tau</span><span class="p">(</span><span class="n">df_orders</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y_dummy</span><span class="p">.</span><span class="n">index</span><span class="p">],</span> <span class="n">y_dummy</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Preds score"</span><span class="p">,</span> <span class="n">preds_score</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">output_path</span><span class="p">):</span>
            <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">output_path</span><span class="p">)</span>

        <span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">args</span><span class="p">.</span><span class="n">output_path</span> <span class="o">+</span> <span class="sa">f</span><span class="s">'/model_epoch_</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s">_</span><span class="si">{</span><span class="n">preds_score</span><span class="si">}</span><span class="s">.bin'</span><span class="p">)</span>
</pre></table></code></div></div><h1 id="result">Result</h1><p>public score : 0.8412</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/nlp/'>NLP</a>, <a href='/categories/kaggle/'>KAGGLE</a>, <a href='/categories/ai4code/'>AI4CODE</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/nlp/" class="post-tag no-text-decoration" >nlp</a> <a href="/tags/kaggle/" class="post-tag no-text-decoration" >kaggle</a> <a href="/tags/codebert/" class="post-tag no-text-decoration" >codebert</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=codebert%28base%29+-+%5B1md%2B20code%5D%E2%80%99s+CLS+ranking+0.8412+-+MNG&url=https%3A%2F%2Fmoongthy.github.io%2Fposts%2Fai4code-codebert%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=codebert%28base%29+-+%5B1md%2B20code%5D%E2%80%99s+CLS+ranking+0.8412+-+MNG&u=https%3A%2F%2Fmoongthy.github.io%2Fposts%2Fai4code-codebert%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fmoongthy.github.io%2Fposts%2Fai4code-codebert%2F&text=codebert%28base%29+-+%5B1md%2B20code%5D%E2%80%99s+CLS+ranking+0.8412+-+MNG" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div><script src="https://utteranc.es/client.js" repo="Moongthy/Moongthy.github.io" issue-term="pathname" theme="github-dark" crossorigin="anonymous" async> </script></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/fgsm/">적대적 예제의 설명과 활용 (Fast Gradient Sign Method, FGSM) - Ian J.Goodfellow, Jonathan Shelens & Christian Szegedy</a><li><a href="/posts/pgd/">적대적 공격에 저항하는 딥러닝 모델을 향하여 (Towards Deep Learning Models Resistant to Adversarial Attacks - Aleksnader Madry, Aleksandar Makelov, Ludwig Schmidt, Dimitris Tsipras, Adrian Vladu)</a><li><a href="/posts/dtoverview/">1 결정 트리 개요</a><li><a href="/posts/dtalg/">2 결정 트리 알고리즘</a><li><a href="/posts/varbias/">3 분산(variance)과 편향(bias)</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/nlp/">nlp</a> <a class="post-tag" href="/tags/decision-tree/">decision tree</a> <a class="post-tag" href="/tags/kaggle/">kaggle</a> <a class="post-tag" href="/tags/bert/">bert</a> <a class="post-tag" href="/tags/gradient-boosting/">gradient boosting</a> <a class="post-tag" href="/tags/random-forest/">random forest</a> <a class="post-tag" href="/tags/transformer/">transformer</a> <a class="post-tag" href="/tags/adversarial-example/">adversarial example</a> <a class="post-tag" href="/tags/decoder/">decoder</a> <a class="post-tag" href="/tags/distillbert/">distillbert</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ai4code/"><div class="card-body"> <em class="small" data-ts="1662776100" data-df="ll" > Sep 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Google AI4Code</h3><div class="text-muted small"><p> Overview 이 대회의 목적은 파이썬 (주피터) 노트북의 코드와 코멘트 사이의 관계를 이해하는 것이다. 당신은 주어진 노트북의 코드셀의 순서에 따라, 어떤 자연어가 코드와 연관되는지 파악하여 마크다운 셀의 순서를 재구성 해야한다. Context 구글과 알파벳의 리서치 팀은 머신러닝이 소프트웨어 개발자들을 보조할 수 있는 새로운 방법을 찾고있으...</p></div></div></a></div><div class="card"> <a href="/posts/ai4code-baseline/"><div class="card-body"> <em class="small" data-ts="1662776101" data-df="ll" > Sep 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>distillbert(small) - baseline 0.7499</h3><div class="text-muted small"><p> Load data raw data를 dataframe으로 바꿔주는 함수 def get_df(data_dir, num_rows, folder=&#39;train&#39;): paths_train = list((data_dir / folder).glob(&#39;*.json&#39;))[:num_rows] notebooks_train = [ rea...</p></div></div></a></div><div class="card"> <a href="/posts/ai4code-pairwise/"><div class="card-body"> <em class="small" data-ts="1662776102" data-df="ll" > Sep 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>distillbert(small) - pairwise 0.8171</h3><div class="text-muted small"><p> Preprocess 이것저것 걸러내기 class PairwisePreprocessor(Preprocessor): def __init__(self, **args): self.__dict__.update(args) super(PairwisePreprocessor, self).__init__(**args) ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/ai4code-pairwise/" class="btn btn-outline-primary" prompt="Older"><p>distillbert(small) - pairwise 0.8171</p></a> <a href="/posts/ai4code-cb-pw-ensemble/" class="btn btn-outline-primary" prompt="Newer"><p>graphcodebert+pairwise ensemble 0.8462</p></a></div><script src="https://utteranc.es/client.js" repo="" issue-term="" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">mng</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/nlp/">nlp</a> <a class="post-tag" href="/tags/decision-tree/">decision tree</a> <a class="post-tag" href="/tags/kaggle/">kaggle</a> <a class="post-tag" href="/tags/bert/">bert</a> <a class="post-tag" href="/tags/gradient-boosting/">gradient boosting</a> <a class="post-tag" href="/tags/random-forest/">random forest</a> <a class="post-tag" href="/tags/transformer/">transformer</a> <a class="post-tag" href="/tags/adversarial-example/">adversarial example</a> <a class="post-tag" href="/tags/decoder/">decoder</a> <a class="post-tag" href="/tags/distillbert/">distillbert</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
